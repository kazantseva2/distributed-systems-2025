# Высоконагруженный сервис отзывов и рейтингов для е-cоmmerсе (Проект А5)

## Описание проекта

Сервис для сбора, хранения и анализа отзывов о товарах интернет-магазина.  
Проект ориентирован на **высокие нагрузки** во время акций и распродаж, когда тысячи пользователей одновременно читают и пишут отзывы.

### Технологический стек
- **Java**
- **Spring Boot**
- **MongoDB** — основное хранилище данных.
- **Hazelcast** — кэширование агрегированных данных и rate limiting.
- **OpenSearch** — полнотекстовый поиск и аналитика.
- **REST API** — взаимодействие с клиентами и сервисами.

---

## Сценарии работы

### 1. Добавление нового отзыва

**Цель:**  
Пользователь оставляет отзыв о товаре.

**Основной поток:**
1. Пользователь отправляет запрос `POST /api/products/{productId}/reviews`.
2. Система проверяет:
   - Авторизован ли пользователь.
   - Не превышен ли лимит отзывов (rate limiting).
   - Существует ли товар.
3. Создаётся новый документ в коллекции `reviews`.
4. Пересчитывается агрегированный рейтинг и количество отзывов для `productId`.
5. Обновляются данные в:
   - Коллекции `products`;
   - Кэше Hazelcast (`product_summary_cache`);
   - Статистике пользователя (`reviewsCount`, `lastReviewDate`).

**Исключения:**
- Превышен лимит на количество отзывов в минуту → `HTTP 429`.
- Отзыв уже существует от этого пользователя → `HTTP 400`.

---

### 2. Получение отзывов с фильтрацией

**Цель:**  
Показать список отзывов для конкретного товара с возможностью фильтрации и сортировки.

**Основной поток:**
1. Пользователь отправляет `GET /api/products/{productId}/reviews?rating=4&hasText=true&sortBy=date`.
2. Система выполняет поиск в MongoDB с фильтрами:
   - `productId`
   - `rating` (опционально)
   - `hasText = true` (только отзывы с текстом)
   - `moderationStatus = APPROVED`
3. Возвращает список отзывов, отсортированный по указанному параметру.

**Дополнительно:**
- Пагинация через `limit` и `offset`.
- Возможность сортировки по полезности (`likes`).

---

### 3. Получение агрегированных данных по товару

**Цель:**  
Быстро получить средний рейтинг и количество отзывов.

**Основной поток:**
1. Клиент делает запрос `GET /api/products/{productId}/summary`.
2. Система проверяет Hazelcast-кэш.
3. Если кэш пуст:
   - Данные берутся из MongoDB (`products`);
   - Результат сохраняется в кэш на 10 минут.
4. Возвращается JSON с `aggregatedRating` и `countReviews`.

---

### 4. Оценка полезности отзыва

**Цель:**  
Пользователь оценивает отзыв как полезный или бесполезный.

**Основной поток:**
1. Запрос `POST /api/reviews/{reviewId}/feedback?useful=true`.
2. Система находит отзыв по `reviewId`.
3. Увеличивает счётчик:
   - `likes`, если `useful=true`;
   - `dislikes`, если `useful=false`.
4. Сохраняет обновлённые данные в MongoDB.

---

### 5. Модерация отзывов

**Цель:**  
Администратор проверяет и утверждает или отклоняет отзыв.

**Основной поток:**
1. Запрос `POST /api/reviews/{reviewId}/moderate`.
2. Модератор передаёт новый статус (`APPROVED` / `REJECTED`).
3. Система обновляет поле `moderationStatus` в документе `reviews`.
4. Если отзыв одобрен:
   - Пересчитывается агрегированный рейтинг товара;
   - Обновляется кэш Hazelcast.

---

### 7. Регистрация пользователя

**Цель:**  
Создать нового пользователя в системе.

**Основной поток:**
1. Запрос `POST /api/users/register`.
2. Проверяется уникальность `email`.
3. Создаётся документ `User`:
   - `reviewsCount = 0`;
   - `createdAt = now()`;
   - `active = true`.
4. Сохраняется в коллекции `users`.

---

### 8. Просмотр профиля пользователя

**Цель:**  
Получить информацию о пользователе.

**Основной поток:**
1. Запрос `GET /api/users/{userId}`.
2. Система находит пользователя в MongoDB.
3. Возвращает:
   - `name`
   - `email`
   - `reviewsCount`
   - `lastReviewDate`
   - `active` статус

---

### 10. Аналитика и индексация отзывов

**Цель:**  
Собирать и анализировать данные через OpenSearch.

**Основной поток:**
1. Периодически выбираются новые отзывы из MongoDB.
2. Отправляются в OpenSearch для индексации.
3. Используются для аналитических запросов:
   - Часто упоминаемые слова в негативных отзывах;
   - Тренды оценок по времени;
   - Список самых полезных отзывов.

---

### 11. Удаление пользователя и его отзывов

**Цель:**  
Полное удаление профиля (например, по GDPR).

**Основной поток:**
1. Запрос `DELETE /api/users/{userId}`.
2. Удаляется документ пользователя.
3. Удаляются все отзывы, где `userId = {userId}`.
4. Обновляются агрегированные рейтинги товаров, где были его отзывы.

---

### 12. Получение списка активных пользователей

**Цель:**  
Показать самых активных авторов отзывов.

**Основной поток:**
1. Запрос `GET /api/users?active=true&minReviews=10`.
2. Система фильтрует пользователей по:
   - `active = true`;
   - `reviewsCount >= minReviews`.
3. Возвращает список отсортированных по `reviewsCount`.

---

### 13. Восстановление доверия (Trust Score)

**Цель:**  
Анализировать репутацию пользователя.

**Основной поток:**
1. После модерации одобренных отзывов:
   - Для каждого пользователя увеличивается `trustScore`.
   - Для отклонённых — уменьшается.
2. Показатель `trustScore` влияет на приоритет публикаций и модерации.

---

### Итого

Система обеспечивает:
- Добавление, хранение и модерацию отзывов;
- Мгновенный доступ к агрегированным рейтингам через кэш;
- Контроль частоты действий пользователей;
- Возможность аналитики и поиска по отзывам через OpenSearch;
- Управление пользователями и их активностью.

---
